services:
  server:
    environment:
      - ICEBERG_REST__SECRET_BACKEND=KV2
      - ICEBERG_REST__VAULT={url="http://hvault:8200", user="test", password="test", secret_mount="secret"}
    depends_on:
      hvault:
        condition: service_healthy
      inithvault:
        condition: service_completed_successfully
      testhvault:
        condition: service_completed_successfully
  hvault:
    image: hashicorp/vault:latest
    ports:
      - 8200:8200
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=myroot
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    #    cap_add:
    #      - IPC_LOCK
    healthcheck:
      test: [ "CMD", "vault", "status", "-address", "http://hvault:8200" ]
      interval: 1s
      timeout: 20s
      retries: 5
      start_period: 30s
  inithvault:
    image: hashicorp/vault:latest
    depends_on:
      hvault:
        condition: service_healthy
    restart: "no"
    entrypoint: [ "sh", "/init_vault.sh" ]
    volumes:
      - ./init_vault.sh:/init_vault.sh
  testhvault:
    image: hashicorp/vault:latest
    depends_on:
      hvault:
        condition: service_started
    restart: "no"
    entrypoint: [ "sh", "-c" ]
    command: [ "sleep 10 && vault status -address http://hvault:8200" ]
