[tox]
requires =
    tox>=4
env_list = py
toxworkdir=/tmp/.tox

[testenv]
passenv = 
    LAKEKEEPER_TEST__MANAGEMENT_URL
    LAKEKEEPER_TEST__CATALOG_URL
    LAKEKEEPER_TEST__OPENID_*
setenv =
    LAKEKEEPER_TEST__S3_STS_MODE=both
deps =
    pytest>=7
    pytest-sugar
    pyiceberg[s3fs, adlfs]==0.7.1
    dataclasses
    uuid
    pyarrow
    pandas
    requests
    boto3
    fsspec

[testenv:pyiceberg]
description = pyiceberg
passenv =
    {[testenv]passenv}
    LAKEKEEPER_TEST__S3_*
    # LAKEKEEPER_TEST__AZURE_*  https://github.com/apache/iceberg-python/issues/1146
commands =
    pytest {posargs:tests} tests/test_pyiceberg.py -rs

; Spark needs special treatment because we apparently cannot configure a remote-signing and an sts catalog simultaneously
[testenv:spark_remote_signing]
description = spark_remote_signing
passenv =
    {[testenv]passenv}
    LAKEKEEPER_TEST__S3_*
setenv =
    LAKEKEEPER_TEST__S3_STS_MODE=disabled
deps =
    {[testenv]deps}
    findspark
commands =
    pytest {posargs:tests} tests/test_spark.py -rs

[testenv:spark_sts]
description = spark_sts
passenv =
    {[testenv]passenv}
    LAKEKEEPER_TEST__S3_*
setenv =
    LAKEKEEPER_TEST__S3_STS_MODE=enabled
deps =
    {[testenv]deps}
    findspark
commands =
    pytest {posargs:tests} tests/test_spark.py -rs

[testenv:spark_adls]
description = spark_adls
passenv =
    {[testenv]passenv}
    LAKEKEEPER_TEST__AZURE_*
deps =
    {[testenv]deps}
    findspark
commands =
    pytest {posargs:tests} tests/test_spark.py -rs


[testenv:trino]
description = trino
passenv =
    {[testenv]passenv}
    LAKEKEEPER_TEST__S3_*
    # LAKEKEEPER_TEST__AZURE_*  https://github.com/trinodb/trino/issues/23238
    LAKEKEEPER_TEST__TRINO_URI
setenv =
    LAKEKEEPER_TEST__S3_STS_MODE=enabled
deps =
    {[testenv]deps}
    trino
commands =
    pytest {posargs:tests} tests/test_trino.py -rs

[testenv:starrocks]
description = starrocks
passenv =
    {[testenv]passenv}
    LAKEKEEPER_TEST__STARROCKS_URI
    LAKEKEEPER_TEST__S3_*
setenv =
    LAKEKEEPER_TEST__S3_STS_MODE=enabled
deps =
    {[testenv]deps}
    starrocks
    sqlalchemy<3.0
commands =
    pytest {posargs:tests} tests/test_starrocks.py -rs
